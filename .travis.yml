sudo: false
language: python
os: linux
install:
- &upgrade_python_toolset pip install --upgrade pip setuptools wheel
- pip install tox-travis
- pip install coveralls
script: []
after_success:
- coveralls

jobs:
  fast_finish: true
  include:
  - stage: test
    name: "Python 3.4"
    python: 3.4
    script:
    - tox -e py34
  - stage: test
    name: "Python 3.5"
    python: 3.5
    script:
    - tox -e py35
  - stage: test
    name: "Python 3.6"
    python: 3.6
    script:
    - tox -e py36
  - stage: test
    name: "Python 3.7"
    python: 3.7
    dist: xenial
    sudo: true
    script:
    - tox -e py37
  - stage: test
    name: "PyPy3"
    python: pypy3.5
    script:
    - tox -e pypy3

  - stage: Static analisys
    name: "PyLint"
    python: 3.6
    services: []
    install:
    - *upgrade_python_toolset
    - pip install tox
    script:
    - tox -e pylint
    after_success: skip
  - stage: Static analisys
    name: "Bandit"
    python: 3.6
    services: []
    install:
    - *upgrade_python_toolset
    - pip install tox
    script:
    - tox -e bandit
    after_success: skip
  - stage: Static analisys
    name: "MyPy"
    python: 3.7
    dist: xenial
    sudo: true
    services: []
    install:
    - *upgrade_python_toolset
    - pip install tox
    script:
    - tox -e mypy
    after_success: skip

  - stage: Test cythonized
    name: "Python 3.4"
    python: 3.4
    script:
    - tox -e py34-nocov
    after_success: skip
  - stage: Test cythonized
    name: "Python 3.5"
    python: 3.5
    script:
    - tox -e py35-nocov
    after_success: skip
  - stage: Test cythonized
    name: "Python 3.6"
    python: 3.6
    script:
    - tox -e py36-nocov
    after_success: skip
  - stage: Test cythonized
    name: "Python 3.7"
    python: 3.7
    dist: xenial
    sudo: true
    script:
    - tox -e py37-nocov
    after_success: skip

  - stage: Code style check
    name: "PEP8"
    python: 3.6
    install:
    - *upgrade_python_toolset
    - pip install tox
    script:
    - tox -e pep8
    after_success: skip
  - stage: Code style check
    name: "PEP257"
    python: 3.6
    install:
    - *upgrade_python_toolset
    - pip install tox
    script:
    - tox -e pep257
    after_success: skip

  - stage: deploy
    # This prevents job from appearing in test plan unless commit is tagged:
    if: tag IS present
    # Run on pypy to build not cythonized wheel
    python: pypy3.5
    services:
    - docker
    install:
    - *upgrade_python_toolset
    script:
    - ./tools/run_docker.sh "threaded"
    before_deploy:
    - pip install -r build_requirements.txt
    - python setup.py bdist_wheel
    deploy:
    - provider: pypi
      # `skip_cleanup: true` is required to preserve binary wheels, built
      # inside of manylinux1 docker container during `script` step above.
      skip_cleanup: true
      user: penguinolog
      password:
        secure: "h1gXulNJxdjdUtPXDwUf/2MltjjiTy/cSsv+67Bxr9PAXSo9s0ynnhijKavE0QlKPr0NDJcEcl79dEN3gx1rkbAFZ+YRJfx0KHy26ImNAIx+npOFjGko87KhMNkrE3QBn9carWNnjYA4rCuUqbv/Znk9xixleE/sHJbKnkkTrerSI2jkznMa6h0FNVCEPzFesHmll7rBy4CjFkRcWNX8nfKNIV9rHFI7mXm8+jzl0msOnkEcKRqAk+MUwVjcD9XtpF42uA0nQTtqjWFdwSUxxBJKMyrkkI0o8Uk06EewkgJGwjGpvn+EUm1hBpjGrXUQQJyr20SZdC0CqaqXD/axISAtQPzP5I4Ey3VkLDV4mZuQjeNlbRbTH0Q7af+CpnOpFtYobIs1/HjB5wztazegT8uk4ZU/GheYqknXmtg9Ga8NV47sIpLC/hTLXWP+O/k0JKRYP9CgjTml2nLykNjZy4KRnlCUerYH8d4bNz687ElXU2bLtlBxyigUc9oo31DvNG+vB2axOp8wGiRTEpfBVPEF6EYUj+qSbX4ep4o/mWp+ax5YlLVYVoXkXpNecIggICAChIkqEl9MtGzTu31s3sBKpk9WuqoyHG80TDo2Tet6zWYx3itUx9M0SLkrML9Hs5WKsXDZE6jZrVHtx8lWuuZZl5JQkXYtd358lwJmEBM="
      on:
        tags: true
        distributions: sdist
      skip_upload_docs: true

cache: pip
before_cache:
- rm -f $HOME/.cache/pip/log/debug.log
